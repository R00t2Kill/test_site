<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Campus Microgrid Orchestration System</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: #333; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; }
        header { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        h1 { color: #667eea; font-size: 28px; margin-bottom: 5px; }
        .subtitle { color: #666; font-size: 14px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .card-title { font-size: 14px; color: #666; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .card-value { font-size: 36px; font-weight: bold; color: #333; margin-bottom: 5px; }
        .card-unit { font-size: 18px; color: #999; margin-left: 5px; }
        .card-subtitle { font-size: 12px; color: #999; margin-top: 5px; }
        .status-indicator { display: inline-block; width: 12px; height: 12px; border-radius: 50%; margin-right: 8px; }
        .status-green { background: #10b981; }
        .status-yellow { background: #f59e0b; }
        .status-red { background: #ef4444; }
        .alert-level { display: inline-flex; align-items: center; padding: 6px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; text-transform: uppercase; }
        .alert-green { background: #d1fae5; color: #065f46; }
        .alert-yellow { background: #fef3c7; color: #92400e; }
        .alert-red { background: #fee2e2; color: #991b1b; }
        .recommendations { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; }
        .recommendation-item { padding: 15px; margin-bottom: 10px; border-left: 4px solid #667eea; background: #f9fafb; border-radius: 4px; }
        .recommendation-item.high { border-left-color: #ef4444; background: #fef2f2; }
        .recommendation-item.medium { border-left-color: #f59e0b; background: #fffbeb; }
        .recommendation-title { font-weight: 600; margin-bottom: 5px; color: #333; }
        .recommendation-message { font-size: 14px; color: #666; }
        .chart-container { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); margin-bottom: 20px; height: 400px; }
        .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
        .tab { padding: 10px 20px; background: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; color: #666; transition: all 0.3s; }
        .tab.active { background: #667eea; color: white; }
        .tab:hover { background: #764ba2; color: white; }
        .actions { display: flex; gap: 10px; margin-top: 20px; flex-wrap: wrap; }
        .btn { padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s; }
        .btn:hover { background: #764ba2; transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #6b7280; }
        .btn-secondary:hover { background: #4b5563; }
        .progress-bar { width: 100%; height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.5s; display: flex; align-items: center; justify-content: center; color: white; font-size: 11px; font-weight: 600; }
        #fileInput { display: none; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.active { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 10px; max-width: 500px; width: 90%; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } .chart-container { height: 300px; } }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Campus Microgrid Orchestration System</h1>
            <p class="subtitle">Rajasthan Technical University - Real-Time Energy Intelligence Platform</p>
        </header>
        <div id="statusCards" class="grid"></div>
        <div class="recommendations">
            <h2 style="margin-bottom: 15px; color: #667eea;">Active Recommendations</h2>
            <div id="recommendationsList"><p style="color: #999;">Loading...</p></div>
        </div>
        <div class="card" style="margin-bottom: 20px;">
            <h2 style="margin-bottom: 20px; color: #667eea;">Manual Controls</h2>
            <div class="grid">
                <div class="card" style="background: #f9fafb; box-shadow: none;">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Battery Control</h3>
                    <select id="batteryAction" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 10px;">
                        <option value="">Select Action...</option>
                        <option value="charge">Force Charge</option>
                        <option value="discharge">Force Discharge</option>
                        <option value="auto">Auto Mode</option>
                    </select>
                    <input type="number" id="batteryPower" placeholder="Power (kW)" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 10px;" min="0" max="50">
                    <button class="btn" style="width: 100%;" onclick="controlBattery()">Execute Command</button>
                </div>
                <div class="card" style="background: #f9fafb; box-shadow: none;">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Schedule Load</h3>
                    <input type="text" id="loadName" placeholder="Load Name" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 10px;">
                    <input type="number" id="loadPower" placeholder="Power (kW)" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 10px;" min="0">
                    <input type="number" id="loadDuration" placeholder="Duration (hours)" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ddd; margin-bottom: 10px;" min="0.5" step="0.5">
                    <button class="btn" style="width: 100%;" onclick="scheduleLoad()">Find Optimal Time</button>
                </div>
                <div class="card" style="background: #f9fafb; box-shadow: none;">
                    <h3 style="margin-bottom: 15px; font-size: 16px;">Load Shedding</h3>
                    <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                        <input type="checkbox" id="shedTier4" style="margin-right: 10px; width: 18px; height: 18px;">
                        <span>Shed Tier 4 (HVAC) -15%</span>
                    </label>
                    <label style="display: flex; align-items: center; margin-bottom: 10px; cursor: pointer;">
                        <input type="checkbox" id="shedTier3" style="margin-right: 10px; width: 18px; height: 18px;">
                        <span>Shed Tier 3 (Workshops) -10%</span>
                    </label>
                    <button class="btn" style="width: 100%; background: #ef4444; margin-bottom: 10px;" onclick="applyLoadShedding()">Apply</button>
                    <button class="btn btn-secondary" style="width: 100%;" onclick="clearLoadShedding()">Clear</button>
                </div>
            </div>
        </div>
        <div class="tabs">
            <button class="tab active" onclick="switchTab('realtime')">Real-Time</button>
            <button class="tab" onclick="switchTab('history')">Historical</button>
            <button class="tab" onclick="switchTab('forecast')">Forecast</button>
            <button class="tab" onclick="switchTab('reports')">Reports</button>
        </div>
        <div id="realtimeView" class="chart-container"><canvas id="realtimeChart"></canvas></div>
        <div id="historyView" class="chart-container" style="display: none;"><canvas id="historyChart"></canvas></div>
        <div id="forecastView" class="chart-container" style="display: none;"><canvas id="forecastChart"></canvas></div>
        <div id="reportsView" class="card" style="display: none;">
            <h3 style="margin-bottom: 20px;">System Reports</h3>
            <div class="grid" id="reportCards"></div>
        </div>
        <div class="actions">
            <button class="btn" onclick="document.getElementById('fileInput').click()">Import Data</button>
            <button class="btn btn-secondary" onclick="refreshData()">Refresh</button>
            <button class="btn btn-secondary" onclick="window.open('/docs', '_blank')">API Docs</button>
        </div>
        <div class="modal" id="scheduleModal">
            <div class="modal-content">
                <h2 style="margin-bottom: 20px; color: #667eea;">Schedule Result</h2>
                <div id="scheduleResult"></div>
                <button class="btn" style="margin-top: 20px;" onclick="closeModal()">Close</button>
            </div>
        </div>
        <input type="file" id="fileInput" accept=".csv" onchange="uploadFile(this.files[0])">
    </div>
    <script>
let realtimeChart,historyChart,forecastChart;document.addEventListener('DOMContentLoaded',()=>{initCharts();refreshData();setInterval(refreshData,10000)});async function refreshData(){try{const r=await fetch('/api/status');const d=await r.json();const storedKwh=(d.battery_soc/100)*d.battery_capacity_kwh;document.getElementById('statusCards').innerHTML=`<div class="card"><div class="card-title">System Status</div><div class="card-value"><span class="alert-level alert-${d.alert_level}"><span class="status-indicator status-${d.alert_level}"></span>${d.alert_level.toUpperCase()}</span></div>${d.manual_control_active?'<div class="card-subtitle" style="color: #f59e0b; font-weight: 600;">⚙️ '+d.manual_control_active+'</div>':''}</div><div class="card"><div class="card-title">Solar</div><div class="card-value">${d.solar_kw.toFixed(1)}<span class="card-unit">kW</span></div></div><div class="card"><div class="card-title">Wind</div><div class="card-value">${d.wind_kw.toFixed(1)}<span class="card-unit">kW</span></div></div><div class="card"><div class="card-title">Demand</div><div class="card-value">${d.demand_kw.toFixed(1)}<span class="card-unit">kW</span></div>${d.load_shedding_active?'<div class="card-subtitle" style="color: #ef4444;">⚠️ Load Shedding Active</div>':''}</div><div class="card"><div class="card-title">Battery SOC</div><div class="card-value">${d.battery_soc.toFixed(1)}<span class="card-unit">%</span></div><div class="card-subtitle">${storedKwh.toFixed(1)} kWh stored</div><div class="progress-bar"><div class="progress-fill" style="width: ${d.battery_soc}%">${d.battery_capacity_kwh} kWh</div></div></div><div class="card"><div class="card-title">Grid Import</div><div class="card-value">${d.grid_import_kw.toFixed(1)}<span class="card-unit">kW</span></div></div><div class="card"><div class="card-title">Renewable Util</div><div class="card-value" style="color: #10b981;">${d.renewable_utilization_percent.toFixed(1)}<span class="card-unit">%</span></div><div class="card-subtitle">${d.carbon_avoided_kg.toFixed(2)} kg CO₂/hr</div></div>`;if(d.recommendations&&d.recommendations.length>0){document.getElementById('recommendationsList').innerHTML=d.recommendations.map(r=>`<div class="recommendation-item ${r.priority}"><div class="recommendation-title">${r.type}</div><div class="recommendation-message">${r.message}</div></div>`).join('')}else{document.getElementById('recommendationsList').innerHTML='<p style="color: #999;">No active recommendations</p>'}realtimeChart.data.labels.push(new Date().toLocaleTimeString());realtimeChart.data.datasets[0].data.push(d.solar_kw);realtimeChart.data.datasets[1].data.push(d.wind_kw);realtimeChart.data.datasets[2].data.push(d.demand_kw);if(realtimeChart.data.labels.length>20){realtimeChart.data.labels.shift();realtimeChart.data.datasets.forEach(ds=>ds.data.shift())}realtimeChart.update('none')}catch(e){console.error(e)}}function initCharts(){realtimeChart=new Chart(document.getElementById('realtimeChart'),{type:'line',data:{labels:[],datasets:[{label:'Solar',data:[],borderColor:'#f59e0b',tension:0.4},{label:'Wind',data:[],borderColor:'#06b6d4',tension:0.4},{label:'Demand',data:[],borderColor:'#ef4444',tension:0.4}]},options:{responsive:true,maintainAspectRatio:false,plugins:{title:{display:true,text:'Real-Time'}}}});historyChart=new Chart(document.getElementById('historyChart'),{type:'line',data:{labels:[],datasets:[]},options:{responsive:true,maintainAspectRatio:false}});forecastChart=new Chart(document.getElementById('forecastChart'),{type:'line',data:{labels:[],datasets:[]},options:{responsive:true,maintainAspectRatio:false}})}function switchTab(tab){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));event.target.classList.add('active');document.getElementById('realtimeView').style.display=tab==='realtime'?'block':'none';document.getElementById('historyView').style.display=tab==='history'?'block':'none';document.getElementById('forecastView').style.display=tab==='forecast'?'block':'none';document.getElementById('reportsView').style.display=tab==='reports'?'block':'none';if(tab==='history')loadHistory();if(tab==='forecast')loadForecast();if(tab==='reports')loadReports()}async function loadHistory(){const r=await fetch('/api/history?hours=24');const d=await r.json();if(d.data){historyChart.data.labels=d.data.map(i=>new Date(i.timestamp).toLocaleTimeString());historyChart.data.datasets=[{label:'Solar',data:d.data.map(i=>i.solar_kw),borderColor:'#f59e0b'},{label:'Wind',data:d.data.map(i=>i.wind_kw),borderColor:'#06b6d4'},{label:'Demand',data:d.data.map(i=>i.demand_kw),borderColor:'#ef4444'}];historyChart.update()}}async function loadForecast(){const r=await fetch('/api/forecast?hours=24');const d=await r.json();if(d.forecast){forecastChart.data.labels=d.forecast.timestamp.map(t=>new Date(t).toLocaleTimeString());forecastChart.data.datasets=[{label:'Solar Forecast',data:d.forecast.solar_kw,borderColor:'#f59e0b',fill:true},{label:'Wind Forecast',data:d.forecast.wind_kw,borderColor:'#06b6d4',fill:true},{label:'Demand Forecast',data:d.forecast.demand_kw,borderColor:'#ef4444',fill:true}];forecastChart.update()}}async function loadReports(){const[c,f]=await Promise.all([fetch('/api/reports/carbon?period=monthly'),fetch('/api/reports/financial?period=monthly')]);const carbon=await c.json(),financial=await f.json();document.getElementById('reportCards').innerHTML=`<div class="card" style="background: #ecfdf5;"><h3 style="color: #059669;">Carbon Report</h3><p>CO2 Avoided: ${carbon.carbon_avoided_tonnes} tonnes</p><p>Renewable: ${carbon.renewable_utilization_percent}%</p></div><div class="card" style="background: #fef3c7;"><h3 style="color: #92400e;">Financial</h3><p>Savings: ₹${financial.savings_inr.toFixed(2)}</p><p>${financial.savings_percent}% saved</p></div>`}async function controlBattery(){const action=document.getElementById('batteryAction').value;const power=parseFloat(document.getElementById('batteryPower').value)||0;if(!action){alert('Select action');return}if((action==='charge'||action==='discharge')&&power<=0){alert('Enter power value');return}try{const r=await fetch('/api/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:action+'_battery',value:power,duration:3600})});const d=await r.json();if(d.success){alert(`✅ ${d.message}\n\nCurrent Battery: ${d.current_battery_soc.toFixed(1)}% (${d.current_battery_kwh.toFixed(1)} kWh)`);refreshData()}else{alert('❌ Command failed')}}catch(e){alert('❌ Error: '+e.message)}}async function scheduleLoad(){const name=document.getElementById('loadName').value;const power=parseFloat(document.getElementById('loadPower').value);const duration=parseFloat(document.getElementById('loadDuration').value);if(!name||!power||!duration){alert('Fill all fields');return}const r=await fetch('/api/schedule_load',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({load_name:name,power_kw:power,duration_hours:duration,tier:3,preferred_time:'any'})});const d=await r.json();if(d.optimal_start_time){document.getElementById('scheduleResult').innerHTML=`<p><strong>Optimal Start:</strong> ${new Date(d.optimal_start_time).toLocaleString()}</p><p><strong>Renewable:</strong> ${d.estimated_renewable_percent.toFixed(1)}%</p><p>${d.reason}</p>`;document.getElementById('scheduleModal').classList.add('active')}}async function applyLoadShedding(){const tier4=document.getElementById('shedTier4').checked;const tier3=document.getElementById('shedTier3').checked;if(!tier4&&!tier3){alert('Select at least one');return}const r=await fetch('/api/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'shed_load',value:JSON.stringify({tier4,tier3,gridLimit:false}),duration:3600})});const d=await r.json();alert(`✅ ${d.message}`);refreshData()}async function clearLoadShedding(){document.getElementById('shedTier4').checked=false;document.getElementById('shedTier3').checked=false;await fetch('/api/control',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({action:'shed_load',value:JSON.stringify({tier4:false,tier3:false,gridLimit:false}),duration:0})});alert('✅ Load shedding cleared');refreshData()}function closeModal(){document.getElementById('scheduleModal').classList.remove('active')}async function uploadFile(file){const fd=new FormData();fd.append('file',file);const r=await fetch('/api/import_data',{method:'POST',body:fd});const d=await r.json();alert(d.success?`Imported ${d.rows_imported} rows`:'Upload failed');refreshData()}
    </script>
</body>
</html>